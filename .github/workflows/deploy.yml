name: Deploy Backend & Frontend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p $HOME/.ssh
          ssh-keyscan -H 31.97.226.111 >> $HOME/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: 31.97.226.111
          username: root
          key: |
            -----BEGIN OPENSSH PRIVATE KEY-----
            b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
            QyNTUxOQAAACBXB4iplWwisVppwA1bSHR9yOK1usTxigvEUeafmaxKrQAAAJiy/ptAsv6b
            QAAAAAtzc2gtZWQyNTUxOQAAACBXB4iplWwisVppwA1bSHR9yOK1usTxigvEUeafmaxKrQ
            AAAEC3SqwwYZ9j0oE6oG8ef5XeyNcoPHvweISG2qwQCcrNa1cHiKmVbCKxWmnADVtIdH3I
            4rW6xPGKC8RR5p+ZrEqtAAAADmdpdGh1Yi1hY3Rpb25zAQIDBAUGBw==
            -----END OPENSSH PRIVATE KEY-----
          port: 22
          debug: true
          script: |

            set -e

            echo "ðŸš€ Deploying BACKEND"
            cd /root/luxuriousonly/backend

            git pull origin main
            npm install
            npm run build || true

            pm2 reload ecosystem.config.js || pm2 start ecosystem.config.js

            echo "âœ… Backend deployed successfully"

            echo "ðŸš€ Deploying FRONTEND"
            cd /root/luxuriousonly/frontend

            git pull origin main
            npm install
            npm run build

            pm2 reload frontend || pm2 start npm --name "frontend" -- start

            echo "âœ… Frontend deployed successfully"
